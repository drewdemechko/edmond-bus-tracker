<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>Edmond Bus Tracker</title>
        <!--<f:metadata>
            <f:viewAction action="#{loginBean.doFilter}" />
        </f:metadata>-->
    </h:head>
    <h:body>
        <ui:composition template="/template/layout.xhtml">
            <ui:define name="content">
                <div class="col-md-9">
                    <br />
                    <p:gmap widgetVar="map" id="gmap" center="35.6526783,-97.4781833" zoom="13" type="ROADMAP"  model="#{createRouteView.draggableModel}" style="width:100%;height:400px">
                        <p:ajax event="markerDrag" listener="#{createRouteView.onMarkerDrag}"/>
                    </p:gmap>
                    <br />
                    <button class="btn btn-default" onclick="initialize()">Start Tracking</button>
                    <br />
                    <h3>Route</h3>
                    <h:selectOneMenu onchange="changeRoute(this.value)">
                        <f:selectItem noSelectionOption="" itemLabel="Select a route"/>
                        <f:selectItems value="#{routeManagement.getRoutes()}" var="r"
                            itemValue="#{r.name}" itemLabel="#{r.name}"></f:selectItems>
                    </h:selectOneMenu>
                </div>
                <script>
                    var routes; //List of BusRouteStops.
                    var selectedRoute = []; //BusRouteStops that match the route selected.
                    var stops = []; //Stops connected to selectedRoute.
                    var markers = []; //Markers for each stop.
                    
                    //Get list of BusRouteStops.
                    $.get("http://localhost:8080/edmond-bus-tracker/api/busroutestopservice/stops", function(data, status){
                        routes = data;
                    });
                    
                    function changeRoute(route){
                        selectedRoute = [];
                        stops = [];
                        var temp = [];
                        var tasks = [];
                        //Get selected route from list of BusRouteStops and get each stop.
                        for (var i = 0; i &lt; routes.length; i++){
                            if (routes[i].route == route){
                                selectedRoute.push(routes[i]);
                                tasks.push($.get("http://localhost:8080/edmond-bus-tracker/api/busstopservice/stops/" + routes[i].stop, function(data, status){
                                   temp.push(data);
                                }));
                            }
                        }
                        //Wait for stops to be received and sort them.
                        $.when.apply($, tasks).done(function(){
                            for (var i = 0; i &lt; selectedRoute.length; i++){
                                for (var j = 0; j &lt; temp.length; j++){
                                    if (temp[j].name == selectedRoute[i].stop)
                                        stops.splice(selectedRoute[i].stopOnRoute, 0, temp[j]);
                                }
                            }
                        });
                        //Remove any empty slots in stops array.
                        for (var i = 0; i &lt; stops.length; i++){
                            if (!stops[i]) stops.splice(i,1);
                            i--;
                        }
                    }
                    
                    function initialize() {
                        //Reset the map.
                        var map = new google.maps.Map(document.getElementById("gmap"), {
                          center: {lat: 35.6526783, lng: -97.4781833},
                          zoom: 13,
                          mapTypeId: google.maps.MapTypeId.ROADMAP
                        });
                        //Reset markers. 
                        for (var i = 0; i &lt; markers.length; i++){
                            markers[i].setMap(null);
                            markers[i] = null;
                            markers = [];
                        }
                        //Set new markers.
                        for (var i = 0; i &lt; stops.length; i++){
                            markers.push(new google.maps.Marker({map:map, 
                                position:new google.maps.LatLng(stops[i].latitude, stops[i].longitude), 
                                id: stops[i].id, ordinal: markers.length}));
                        }
                        //Start simulation if there is more than one stop.
                        if (stops.length &gt; 1) trackRoute(map, 0);
                        
                        //This is the code for getting current location. Irrelevant for simulation.
//                        var infoWindow = new google.maps.InfoWindow({map: map});
//
//                        // Try HTML5 geolocation.
//                        if (navigator.geolocation) {
//                          navigator.geolocation.getCurrentPosition(function(position) {
//                            var pos = {
//                              lat: position.coords.latitude,
//                              lng: position.coords.longitude
//                            };
//
//                            infoWindow.setPosition(pos);
//                            infoWindow.setContent('Location found.');
//                            map.setCenter(pos);
//                            getDirections(map, pos);
//                          }, function() {
//                            handleLocationError(true, infoWindow, map.getCenter());
//                          });
//                        } else {
//                          // Browser doesn't support Geolocation
//                          handleLocationError(false, infoWindow, map.getCenter());
//                        }
                    }

                    function trackRoute(map, n) { //Get directions and draw the path incrementally.
                        var directionsService = new google.maps.DirectionsService();

                        var request = {
                            origin: { lat: stops[n].latitude, lng: stops[n].longitude },
                            destination: { lat: stops[n+1].latitude, lng: stops[n+1].longitude },
                            travelMode: google.maps.TravelMode.DRIVING
                        };

                        directionsService.route(request, function(result, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                                var route = new google.maps.Polyline({
                                    path: [],
                                    geodesic : true,
                                    strokeColor: '#FF0000',
                                    strokeOpacity: 1.0,
                                    strokeWeight: 2,
                                    editable: false,
                                    map:map
                                });

                                var pathCoords = result.routes[0].overview_path;

                                originMarker = new google.maps.Marker({map:map, position: pathCoords[0]});
                                destinationMarker = new google.maps.Marker({map:map, position: pathCoords[pathCoords.length-1]});

                                //The setTimeout will be taken out and current location will be gathered again followed by an api call to 
                                //"https://uco-edmond-bus.herokuapp.com/api/busservice/buses/edit/location/{id}/{lat}/{lng}"
                                //to update location in the database, followed by another getDirections call with current location
                                //making this recursive until pathCoords[i] == current location
                                for (var i = 0; i &lt; pathCoords.length; i++) {                
                                    setTimeout(function(coords) {
                                        route.getPath().push(coords);
                                        map.panTo(coords);
                                        var index = -1;
                                        //Check if stop is reached. 
                                        for (var j = 0; j &lt; pathCoords.length; j++){ 
                                            if (pathCoords[j].lat == coords.lat &amp;&amp; pathCoords[j].lng == coords.lng)
                                                index = j;
                                        }
                                        //If stop is reached then get directions to next stop.
                                        if (index == pathCoords.length-1 &amp;&amp; n &lt; stops.length-2) 
                                            trackRoute(map, n+1);
                                    }, 1000*i, pathCoords[i]);
                                }
                            }
                        });
                        
                    }
                </script>
            </ui:define>
        </ui:composition>
    </h:body>
</html>

<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>Edmond Bus Tracker</title>
        <!--<f:metadata>
            <f:viewAction action="#{loginBean.doFilter}" />
        </f:metadata>-->
    </h:head>
    <h:body>
        <ui:composition template="/template/layout.xhtml">
            <ui:define name="content">
                <div class="col-md-9">
                    <br />
                    <p:gmap widgetVar="map" id="gmap" center="35.6526783,-97.4781833" zoom="13" type="ROADMAP"  model="#{createRouteView.draggableModel}" style="width:100%;height:400px">
                        <p:ajax event="markerDrag" listener="#{createRouteView.onMarkerDrag}"/>
                    </p:gmap>
                    <br />
                    <button class="btn btn-default" onclick="initialize()">Start Tracking</button>
                    <br />
                    <h3>Destination</h3> 
                    <ui:repeat value="#{stopManagementBean.getStops()}" var="s">
                        <h:selectBooleanCheckbox class="#{s.getId()}" onclick="setLatLng(#{s.getLat()}, #{s.getLng()}, #{s.getId()})"/>
                        #{s.getName()}<br/>
                    </ui:repeat>
                </div>
                <script>
                    var lat, lng;
                    
                    function setLatLng(latitude, longitude, id){
                        lat = latitude;
                        lng = longitude;
                        
                        $(':checkbox').each(function() {
                            if ($(this).attr('class') != id)
                                $(this).prop('checked', false);
                        });
                    } 
                    
                    function initialize() {
                        var map = new google.maps.Map(document.getElementById("gmap"), {
                          center: {lat: 35.6526783, lng: -97.4781833},
                          zoom: 13,
                          mapTypeId: google.maps.MapTypeId.ROADMAP
                        });
                        
                        var infoWindow = new google.maps.InfoWindow({map: map});

                        // Try HTML5 geolocation.
                        if (navigator.geolocation) {
                          navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = {
                              lat: position.coords.latitude,
                              lng: position.coords.longitude
                            };

                            infoWindow.setPosition(pos);
                            infoWindow.setContent('Location found.');
                            map.setCenter(pos);
                            getDirections(map, pos);
                          }, function() {
                            handleLocationError(true, infoWindow, map.getCenter());
                          });
                        } else {
                          // Browser doesn't support Geolocation
                          handleLocationError(false, infoWindow, map.getCenter());
                        }
                    }

                    function autoRefresh(map, pathCoords) {
                        var i, route, marker;

                        route = new google.maps.Polyline({
                            path: [],
                            geodesic : true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                            editable: false,
                            map:map
                        });

                        originMarker = new google.maps.Marker({map:map, position: pathCoords[0]});
                        destinationMarker = new google.maps.Marker({map:map, position: pathCoords[pathCoords.length-1]});

                        for (i = 0; i &lt; pathCoords.length; i++) {                
                            setTimeout(function(coords) {
                                route.getPath().push(coords);
                                map.panTo(coords);
                            }, 1000*i, pathCoords[i]);
                        }
                    }

                    function getDirections(map, pos, destLat, destLng) {
                        var directionsService = new google.maps.DirectionsService();

                        var request = {
                            origin: pos,
                            destination: new google.maps.LatLng(lat, lng),
                            travelMode: google.maps.TravelMode.DRIVING
                        };
                        
                        marker=new google.maps.Marker({map:map, position: request.orign});
                        directionsService.route(request, function(result, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                                autoRefresh(map, result.routes[0].overview_path);
                            }
                        });
                    }
                </script>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
